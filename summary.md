# CD Player (cdp) 開発作業ログ

## 1. プロジェクト概要
macOS環境において、CDの挿入を検知し、MusicBrainzからメタデータを取得して全画面表示し、自動的に再生を開始するデスクトップアプリケーションの開発。

## 2. 実装した機能
*   **CD検知 (Detector)**: `/Volumes` ディレクトリの変更をポーリング監視し、CDのマウント/アンマウントを検知。
*   **メタデータ取得 (Fetcher)**: `libdiscid` と `musicbrainzngs` を使用し、ディスクIDからアルバム情報とカバーアートを取得。
*   **再生機能 (Player)**:
    *   当初 `python-vlc` (libvlc) による `cdda://` プロトコル再生を試みたが、macOSの権限制限（Rawデバイスアクセス不可）により断念。
    *   代替案として、**VLCアプリ (`/Applications/VLC.app`) を外部プロセスとして起動**し、標準入力からRCインターフェースで制御する方式を採用。
    *   再生対象を `/dev/rdisk` ではなく、マウントされたボリューム内のオーディオファイル（`.aiff`）を直接指定することで安定再生を実現。
*   **UI (User Interface)**:
    *   `CustomTkinter` を使用した全画面GUI。
    *   アルバムアート、トラック情報、再生コントロール（再生/一時停止、前へ、次へ、取り出し）、簡易スペクトラム表示（ダミー）を実装。
    *   デバッグログ表示機能と終了ボタンを搭載。

## 3. 直面した課題と解決策
1.  **CD再生時の権限エラー**:
    *   **課題**: `cdda:///dev/rdiskX` へのアクセスが `Permission denied` または `cannot open disc` となり失敗。SIP/TCCによる制限。
    *   **解決策**: マウントポイント (`/Volumes/Audio CD/`) 内の仮想AIFFファイルをファイルリストとしてVLCに渡す方式に変更。
2.  **VLC制御の不安定さ**:
    *   **課題**: `next`/`prev` コマンドが効かない、トラック指定再生が失敗する。
    *   **解決策**: 全トラックを一度に引数として渡し、プレイリストとして認識させることで `next`/`prev` を有効化。
3.  **UIとイベントの競合**:
    *   **課題**: 再生開始時に一時的にアンマウントする処理を入れた際、Detectorが「CD取り出し」と誤検知して再生を停止させた。
    *   **解決策**: 再生中（VLC起動中）のアンマウントイベントを無視するロジックを追加。最終的にはアンマウント不要なファイル再生方式にしたため、この競合は自然解消。

## 4. 構成ファイル
*   `main.py`: エントリーポイント。
*   `src/ui.py`: GUI実装。
*   `src/player.py`: VLC外部プロセス制御。
*   `src/detector.py`: CD監視ロジック。
*   `src/fetcher.py`: メタデータ取得。
